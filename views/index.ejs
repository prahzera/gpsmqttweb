<!DOCTYPE html>
<html>
<head>
  <title>Mapa en Tiempo Real</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const map = L.map('map').setView([0, 0], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    const customIcon = L.icon({
      iconUrl: '/images/icon32.png',
      iconSize: [38, 38],
      iconAnchor: [19, 38],
      popupAnchor: [0, -38]
    });

    const marker = L.marker([0, 0], { icon: customIcon }).addTo(map);
    const socket = io();
    let routeLayer = L.layerGroup().addTo(map); // Usar LayerGroup para mantener la ruta

    // Función para dibujar la ruta en el mapa
    const drawRoute = (coords) => {
      routeLayer.clearLayers(); // Limpia la capa antes de agregar nueva ruta
      const latlngs = coords.map(coord => [coord.lat, coord.lon]);
      L.polyline(latlngs, { color: 'red', weight: 3 }).addTo(routeLayer);
    };

    // Obtiene la última ubicación al cargar la página
    fetch('/last-location')
      .then(response => response.json())
      .then(data => {
        if (data.lat && data.lon) {
          map.setView([data.lat, data.lon], 16);
          marker.setLatLng([data.lat, data.lon]);
        }
      });

    // Solicita la ruta de las últimas X horas (por ejemplo, 24 horas) y dibuja
    fetch('/route/24')
      .then(response => response.json())
      .then(data => drawRoute(data));

    // Escucha las nuevas coordenadas del servidor
    socket.on('coordinates', (coord) => {
      marker.setLatLng([coord.lat, coord.lon]);
      map.setView([coord.lat, coord.lon]);

      // Añadir la coordenada al historial y actualizar el mapa
      fetch('/route/24')
        .then(response => response.json())
        .then(data => drawRoute(data));
    });
  </script>
</body>
</html>
